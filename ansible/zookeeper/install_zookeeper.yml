---
# ============================================
# Playbook : Installation de Kafka
# ============================================

- name: Installer et configurer Kafka
  hosts: kafka
  become: yes
  
  vars:
    kafka_version: "3.6.0"
    scala_version: "2.13"
    kafka_dir: "/opt/kafka"
    kafka_log_dir: "/var/lib/kafka-logs"
  
  tasks:
    # --- 1. Installation de Java ---
    - name: Installer Java 11
      apt:
        name: openjdk-11-jdk
        state: present
        update_cache: yes

    # --- 2. Télécharger Kafka ---
    - name: Télécharger Kafka
      get_url:
        url: "https://archive.apache.org/dist/kafka/{{ kafka_version }}/kafka_{{ scala_version }}-{{ kafka_version }}.tgz"
        dest: "/tmp/kafka.tgz"

    # --- 3. Extraire Kafka ---
    - name: Créer le répertoire Kafka
      file:
        path: "{{ kafka_dir }}"
        state: directory

    - name: Extraire Kafka
      unarchive:
        src: "/tmp/kafka.tgz"
        dest: "{{ kafka_dir }}"
        remote_src: yes
        extra_opts: [--strip-components=1]

    # --- 4. Créer le répertoire de logs ---
    - name: Créer le répertoire de logs Kafka
      file:
        path: "{{ kafka_log_dir }}"
        state: directory
        owner: ubuntu
        group: ubuntu

    # --- 5. Configuration Kafka ---
    - name: Configurer server.properties
      copy:
        dest: "{{ kafka_dir }}/config/server.properties"
        content: |
          # Identifiant du broker
          broker.id=1
          
          # Listeners (port d'écoute)
          listeners=PLAINTEXT://0.0.0.0:9092
          advertised.listeners=PLAINTEXT://{{ ansible_default_ipv4.address }}:9092
          
          # Répertoire des logs
          log.dirs={{ kafka_log_dir }}
          
          # Connexion à ZooKeeper
          zookeeper.connect={{ zookeeper_ip }}:2181
          zookeeper.connection.timeout.ms=18000
          
          # Réplication (1 seul broker = pas de réplication)
          default.replication.factor=1
          min.insync.replicas=1
          offsets.topic.replication.factor=1
          transaction.state.log.replication.factor=1
          
          # Rétention des logs
          log.retention.hours=168
          log.segment.bytes=1073741824
          
          # Partitions par défaut
          num.partitions=3
          
          # Performance
          compression.type=snappy

    # --- 6. Créer le service systemd ---
    - name: Créer le service systemd pour Kafka
      copy:
        dest: /etc/systemd/system/kafka.service
        content: |
          [Unit]
          Description=Apache Kafka
          After=network.target zookeeper.service

          [Service]
          Type=simple
          User=ubuntu
          Group=ubuntu
          ExecStart={{ kafka_dir }}/bin/kafka-server-start.sh {{ kafka_dir }}/config/server.properties
          ExecStop={{ kafka_dir }}/bin/kafka-server-stop.sh
          Restart=on-failure
          RestartSec=10

          [Install]
          WantedBy=multi-user.target

    # --- 7. Démarrer Kafka ---
    - name: Recharger systemd
      systemd:
        daemon_reload: yes

    - name: Démarrer Kafka
      systemd:
        name: kafka
        state: started
        enabled: yes

    # --- 8. Attendre que Kafka démarre ---
    - name: Attendre le démarrage de Kafka
      wait_for:
        port: 9092
        delay: 10
        timeout: 60

    # --- 9. Vérifier que Kafka fonctionne ---
    - name: Lister les topics Kafka (vérification)
      shell: "{{ kafka_dir }}/bin/kafka-topics.sh --list --bootstrap-server localhost:9092"
      register: kafka_topics

    - name: Afficher le résultat
      debug:
        msg: "Kafka est UP ✅ - Topics: {{ kafka_topics.stdout_lines }}"